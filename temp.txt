#include <iostream>
#include <raylib.h>
#include <cmath>
#include <rlgl.h>
#include "functions.h"

#define GLSL_VERSION 330
#define RLIGHTS_IMPLEMENTATION
#include "rlights.h"

int main()
{
    const int WIDTH = 800, HEIGHT = 800;
    const char *TITLE = "3d with raylib";
    const int FPS = 144;

    int monitor_width, monitor_height;

    InitWindow(WIDTH, HEIGHT, TITLE);
    SetTargetFPS(FPS);

    RLG_Context ctx = RLG_CreateContext();
    RLG_SetContext(ctx);

    // Camera
    Camera3D camera = {0};
    camera.position = (Vector3){50.0f, 5.0f, 50.0f};
    camera.target = (Vector3){0.0f, 0.0f, 0.0f};
    camera.up = (Vector3){0.0f, 1.0f, 0.0f};
    camera.fovy = 60.0f;
    camera.projection = CAMERA_PERSPECTIVE;

    RLG_UseLight(0, true);
    RLG_SetLightType(0, RLG_OMNILIGHT);
    RLG_SetLightVec3(0, RLG_LIGHT_POSITION, camera.position);

    bool fullscreen = false;
    bool grid = true; 
    bool cursor = false;

    // Sun
    Vector3 sun_position = {0.0f, 0.0f, 0.0f};
    float sun_radius = 15.0f;
    // Earth
    float orbit_radius = 30.0f;
    Vector3 earth_position = {0.0f, 0.0f, orbit_radius};
    float earth_radius = 2.5f;
    // Moon
    float moon_orbit_radius = 5.0f;
    Vector3 moon_position = {0.0f, 0.0f, orbit_radius + 5.0f};
    float moon_radius = 0.5f;

    Mesh sphere_mesh = GenMeshSphere(earth_radius, 32, 32);
    Model earth_model = LoadModelFromMesh(sphere_mesh);

    Shader shader = LoadShader("shaders/glsl330/model.vs", "shaders/glsl330/model.fs");

    earth_model.materials[0].shader = shader;

    unsigned int sunlight = 0;
    RLG_SetLightType(sunlight, RLG_DIRLIGHT);

    RLG_SetLightVec3(sunlight, RLG_LIGHT_DIRECTION, Vector3{-1, -1, 0});

    RLG_SetLightColor(sunlight, WHITE);

    RLG_UseLight(sunlight, true);

    float last_time = 0.0f;

    DisableCursor();

    while (!WindowShouldClose())
    {
        float current_time = GetTime();
        RLG_SetViewPositionV(camera.position);

        if (IsKeyPressed(KEY_C))
        {
            cursor = !cursor;
            if (cursor)
                EnableCursor();
            else
                DisableCursor();
        }

        if (IsKeyPressed(KEY_F)) 
        {
            if (!fullscreen)
            {
                monitor_width = GetMonitorWidth(0);
                monitor_height = GetMonitorHeight(0);

                SetWindowSize(monitor_width, monitor_height);
                ToggleFullscreen();
                DisableCursor();
            }
            else 
            {
                SetWindowSize(WIDTH, HEIGHT);
                ToggleFullscreen();
                DisableCursor();
            }
        }

        if (IsKeyPressed(KEY_G))
        {
            grid = !grid;
        }

        if (current_time - last_time >= 0.05f)
        {        DrawGrid(20, 10.0f);
            last_time = current_time;

            earth_position = getNewEarthPosition(orbit_radius, current_time);
            moon_position = getNewMoonPosition(moon_orbit_radius, current_time, earth_position);
        }

        if (!cursor) 
        {
            UpdateCamera(&camera, CAMERA_THIRD_PERSON);       
        }
        BeginDrawing();
        ClearBackground(BLACK);
        BeginMode3D(camera);
        RLG_DrawModel(earth_model, earth_position, 1.0f, WHITE);
        DrawSphere(sun_position, sun_radius, YELLOW);
        //DrawSphere(earth_position, earth_radius, BLUE);
        DrawSphere(moon_position, moon_radius, GRAY);
        drawEarthOrbit(orbit_radius);
        //DrawText3D(GetFontDefault(), "Earth", {earth_position.x, 3.0f, earth_position.z}, 0.8f, 0.1f, 0.0f, false, WHITE);
        drawMoonOrbit(moon_orbit_radius, earth_position);
        if (grid) 
        {
            DrawGrid(20, 10.0f);
        }
        UnloadModel(earth_model);
        RLG_DestroyContext(ctx);
        UnloadShader(shader);
        EndMode3D();
        DrawFPS(10, 10);
        EndDrawing();
    }

    CloseWindow();

    return 0;
}